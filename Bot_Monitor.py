import streamlit as st
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import pandas as pd

st.set_page_config(page_title="üé´ Bot Fare Monitoring", layout="wide")

# STEP 1: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
scope = [
    "https://spreadsheets.google.com/feeds",
    "https://www.googleapis.com/auth/drive"
]
credentials_dict = {
    "type": st.secrets["GOOGLE_SHEETS"]["type"],
    "project_id": st.secrets["GOOGLE_SHEETS"]["project_id"],
    "private_key_id": st.secrets["GOOGLE_SHEETS"]["private_key_id"],
    "private_key": st.secrets["GOOGLE_SHEETS"]["private_key"],
    "client_email": st.secrets["GOOGLE_SHEETS"]["client_email"],
    "client_id": st.secrets["GOOGLE_SHEETS"]["client_id"],
    "auth_uri": st.secrets["GOOGLE_SHEETS"]["auth_uri"],
    "token_uri": st.secrets["GOOGLE_SHEETS"]["token_uri"],
    "auth_provider_x509_cert_url": st.secrets["GOOGLE_SHEETS"]["auth_provider_x509_cert_url"],
    "client_x509_cert_url": st.secrets["GOOGLE_SHEETS"]["client_x509_cert_url"]
}
credentials = ServiceAccountCredentials.from_json_keyfile_dict(credentials_dict, scope)
gc = gspread.authorize(credentials)

# STEP 2: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
sheet_key = st.secrets["GOOGLE_SHEETS"]["google_sheet_key"]
sh = gc.open_by_key(sheet_key)
worksheet = sh.sheet1
data = worksheet.get_all_records()
df = pd.DataFrame(data)

# STEP 3: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°
if "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" not in df.columns:
    df["‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"] = ""

# STEP 4: ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
df_unchecked = df[df["‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"].isna() | (df["‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"] == "")].copy()
df_unchecked.reset_index(inplace=True)  # ‡πÄ‡∏Å‡πá‡∏ö index ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô Google Sheet

# STEP 5: ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å dropdown
dropdown_options = ["‚úÖ Correct", "‚ùå Not Correct"]

st.title("üìã ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à")

if df_unchecked.empty:
    st.success("üéâ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
else:
    for i, row in df_unchecked.iterrows():
        col1, col2 = st.columns([6, 2])
        with col1:
            st.markdown(f"**PNR:** `{row['PNR']}` | **Fare:** {row['Fare Amount (THB)']} | **Working:** {row['Working']}")
        with col2:
            choice = st.selectbox(
                "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö",
                dropdown_options,
                key=f"dropdown_{i}"
            )
            if choice:
                # ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô Google Sheet ‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡πâ‡∏≠‡∏á +2 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ header ‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 ‡πÅ‡∏•‡∏∞ index ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0)
                sheet_row_index = row["index"] + 2
                worksheet.update_cell(sheet_row_index, df.columns.get_loc("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö") + 1, choice)
                st.success(f"‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÉ‡∏´‡πâ {row['PNR']} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")
                st.experimental_rerun()  # Refresh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡∏°‡πà
